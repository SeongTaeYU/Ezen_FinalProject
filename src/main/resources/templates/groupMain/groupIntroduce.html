<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/groupIntroduce.css">
    <link rel="stylesheet" href="/css/groupMainHeader.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300&display=swap" rel="stylesheet">
    <style>
		body {
			font-family: 'Noto Sans KR', sans-serif;
		}
    </style>
    <title>Document</title>
</head>
<body>
    <div th:replace="~{etc/groupMainHeader::header}"></div>

    <div class="group-main-container">
        <img class="group-main-img" id="previewImage" src=""/>
		<div class="group-main-img-button" id="imageRegisterButton">
          <h3>배경 이미지를 등록하세요</h3>
        </div>
        <input type="file" id="imageInput" class="hidden-input">
        <div class="description-container">
            <h3 class="group-title">자바와 함께하는 이젠 아카데미</h3>
            <div class="description">
                안녕하세요 저희 모임은 이젠 아카데미 입니다.<br/>
                여기는 모임 소개글을 데이터로 받아서<br/>
                표시해 주는 공간입니다.<br/>
                innerHTML을 활용하여 작성할겁니다.♥<br/>
            </div>
        </div>

        <div class="schedule-container">
          <h3 class="schedule-title">Schedule</h3>
          <div class="schedule">여기는 일정을 담을 공간입니다.</div>
        </div>

        <div class="group-member-container">
          <h3 class="group-member-title">Group Member</h3>
          <div class="group-member">그룹의 멤버들이 표시될 자리입니다.</div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    	const imagePath = 'src/main/resources/static/image/groupMain/' + 'new_image.jpg'; 
	 	const imageDiv = document.getElementById('previewImage');
	  	const imageRegisterButton = document.getElementById('imageRegisterButton'); // "배경 이미지를 등록하세요"
	  	const imageInput = document.getElementById('imageInput');
    	
	  	imageRegisterButton.addEventListener('click', () => imageInput.click());
// 	 	imageDiv.addEventListener('click', () => imageInput.click()); 
// 		사진이 입력된 상태에서도 새로 입력이 가능
	  	imageInput.addEventListener('change', () => handleFileSelection(event));
	  	
	  	
	  	$(document).ready(function() {
    		imageDirectoryCheck();
    		
    	});
    	
	  	
	  	// 파일이 변경되면 이미지를 폴더에 저장하고 이미지를 변경해주는 함수
	  	function handleFileSelection(event) {
	  		const reader = new FileReader();
	  		const file = event.target.files[0];
	  		const filename = file.name;
	  		
	  		var lastDot = filename.lastIndexOf('.') + 1;
	  		const fileExtention = filename.substring(lastDot, filename.length);
	  		
	  		// 이미지 확장자 검증
	  		let pictureExtentions = ['jpg', 'png', 'gif'];
	  		if(pictureExtentions.includes(fileExtention)) {
	  			console.log('해당 확장자는 이미지 파일입니다.');
	  			reader.readAsDataURL(file);
	  		} else {
	  			console.log('해당 파일은 이미지가 아닙니다.');
	  			return;
	  		}
	  		
	  		reader.onload = function(event) {
	  			const imageData = event.target.result;
	  			const fileName = "new_image." + fileExtention;
	  			saveImageAjaxRequest(imageData, fileName);
	  		};
	  	}
	  	
	  	// 사진 base64String 문자열을 전달해서 새로운 이름으로 이미지를 저장하는 함수
	  	function saveImageAjaxRequest(imageData, fileName) {
	  		const formData = {
	  				imageData: imageData,
	  				fileName: fileName,
	  		};
	  		
	  		$.ajax({
	  			url: '/image/saveImage',
	  			type: 'POST',
	  			data: JSON.stringify(formData),
	  			contentType: 'application/json',
	  			success: function(response) {
	  				const message = response;
	  				console.log(message);
	  			},
	  			error: function(xhr, status, error) {
	  				console.err('ajax 요청 실패', error);
	  			}
	  		});
	  	}
      

	 	// 디렉터리에 이미지가 존재하는지 체크하고 등록해주는 함수
	  	function imageDirectoryCheck() {
		  /*
			배경 이미지가 폴더에 존재하는 경우에는 바로 등록. 
			존재하지 않는 경우에는 버튼이 보여지게 됨.
		  */
	      $.ajax({
	    	  url: '/image/fileExists',
	    	  type: 'POST',
	    	  data: imagePath,
	    	  contentType: 'application/json',
	    	  success: function(response) {
	    		  if(response) {
	    			  console.log('파일이 존재합니다.');
	    			  imageDiv.style.display = "block";
	    			  imageDiv.src = '../image/groupMain/' + 'new_image.jpg';
	    			  imageRegisterButton.style.display = "none";
	    		  } else {
	    			  console.log('파일이 존재하지 않습니다.');
	    			  imageDiv.style.display = "none";
	    			  imageDiv.src = "";
	    			  imageRegisterButton.style.display = "block";
	    		  }
	    	  },
	    	  error: function(xhr, status, error) {
	    		  console.error('ajax 요청 실패: ', error);
	    	  }
	      });
	  }
     
    </script>
</body>
</html>